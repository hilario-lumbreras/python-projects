import os
import shutil
import rasterio

# Paths
input_file = 'your_large_image.tif'
output_folder = 'output_folder'
output_file = os.path.join(output_folder, 'your_updated_image.tif')

# Function to update tags
def update_tags(tags):
    tags['New_Tag'] = 'Value'
    return tags

# Open the raster dataset in 'deferred' mode
with rasterio.open(input_file, 'r', deferred=True) as src:
    # Get the existing tags
    tags = src.tags()

    # Update the tags
    updated_tags = update_tags(tags)

    # Create the output folder if it doesn't exist
    os.makedirs(output_folder, exist_ok=True)

    # Open the raster dataset again, this time for writing
    profile = src.profile
    profile.update(count=1)  # Ensure we are writing to a single-band dataset
    with rasterio.open(output_file, 'w', **profile) as dst:
        # Iterate over each block in the dataset
        for _, window in src.block_windows():
            # Read the data block by block
            data = src.read(window=window)
            
            # Process the data if needed
            # For example, you can perform some operations on the data here

            # Write the data block to the destination dataset
            dst.write(data, window=window)

        # Update the tags in the destination dataset
        dst.update_tags(**updated_tags)

# Move the output file to the desired folder
shutil.move(output_file, output_folder)
